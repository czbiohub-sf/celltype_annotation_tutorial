---
title: "Untitled"
author: "Yang-Joon Kim"
date: "2023-02-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:


## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
# df = read.csv("/mnt/ibm_lg/yangjoon.kim/excellxgene_tutorial_manuscript/data/neurips2021_cite/s1d1_gex_cite_joint_obs.csv", header = TRUE, sep = ",")
# df
library(rmarkdown)
# Libraries
library(tidyverse)
library(viridis)
library(patchwork)
library(hrbrthemes)
library(circlize)

# Load dataset from github
# data_cite <- read.table("/mnt/ibm_lg/yangjoon.kim/excellxgene_tutorial_manuscript/data/neurips2021_cite/s1d1_gex_cite_leiden001.csv", header=TRUE)
data_cite <- read_csv("/mnt/ibm_lg/yangjoon.kim/excellxgene_tutorial_manuscript/data/neurips2021_cite/s1d1_gex_cite_leiden001.csv")
# Package
library(networkD3)

data_cite_long <- data_cite %>%
  rownames_to_column %>%
  gather(key = 'leiden_GEX_001', value = 'value', -rowname) # %>%
  #filter(value > 0)
colnames(data_cite_long) <- c("source", "target", "value")
data_cite_long$target <- paste(data_cite_long$target, " ", sep="")

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_cite_long$source), as.character(data_cite_long$target)) %>% unique())
 
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_cite_long$IDsource=match(data_cite_long$source, nodes$name)-1
data_cite_long$IDtarget=match(data_cite_long$target, nodes$name)-1

# prepare colour scale
# ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'
# Define the color palettes for the source and target nodes
library(RColorBrewer)
sourceColors <- brewer.pal(9, "Set2")
targetColors <- brewer.pal(9, "Set1")

# generate a histogram to see the distribution of "values", which represents the thickness of the links between the source and the target
hist(data_cite_long$value, main = "Histogram of Value", xlab = "Value")

# Filter the Links data frame to only include links with a value >= threshold
threshold = 30
links_filtered <- data_cite_long[data_cite_long$value >= threshold,]


# saveNetwork(sn, "/mnt/ibm_lg/yangjoon.kim/excellxgene_tutorial_manuscript/celltype_annotation_tutorial/figures/Figure_RNA_CITE_multiome/leiden_GEX_ADT_sankey_R.png")
pdf(file="/mnt/ibm_lg/yangjoon.kim/excellxgene_tutorial_manuscript/celltype_annotation_tutorial/figures/Figure_RNA_CITE_multiome/leiden_GEX_ADT_sankey_R.pdf",
    width=6, height=10)
# Make the Network
sn <- sankeyNetwork(Links = links_filtered, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=TRUE, colourScale=ColourScal, nodeWidth=40, fontSize=13,
                     #nodeColour = list(sourceColors = sourceColors, targetColors = targetColors),
                     nodePadding=20)
dev.off
```

```{r pressure, echo=FALSE}
# Libraries
library(tidyverse)
library(viridis)
library(patchwork)
library(hrbrthemes)
library(circlize)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/13_AdjacencyDirectedWeighted.csv", header=TRUE)
# Package
library(networkD3)

# I need a long format
data_long <- data %>%
  rownames_to_column %>%
  gather(key = 'key', value = 'value', -rowname) %>%
  filter(value > 0)
colnames(data_long) <- c("source", "target", "value")
data_long$target <- paste(data_long$target, " ", sep="")

# From these flows we need to create a node data frame: it lists every entities involved in the flow
nodes <- data.frame(name=c(as.character(data_long$source), as.character(data_long$target)) %>% unique())
 
# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
data_long$IDsource=match(data_long$source, nodes$name)-1 
data_long$IDtarget=match(data_long$target, nodes$name)-1

# prepare colour scale
ColourScal ='d3.scaleOrdinal() .range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'

# Make the Network
sankeyNetwork(Links = data_long, Nodes = nodes,
                     Source = "IDsource", Target = "IDtarget",
                     Value = "value", NodeID = "name", 
                     sinksRight=FALSE, colourScale=ColourScal, nodeWidth=40, fontSize=13, nodePadding=20)
```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
